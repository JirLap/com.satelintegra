<!doctype html>
<html>
    <head>
        <!-- The '/homey.js' script must be included in your settings view to work -->
        <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
    </head>
    <body>
        <h1 data-i18n="settings.title">
            <!--
            This field will automatically be filled by a translated string with key 'settings.title'.
            Read more about translations at Internationalization.
            -->
        </h1>
        
        <fieldset>
            <p>Ipaddress of the ETHM module. (e.g. : 192.168.1.5)</p>
            <table>
                <div class="field row">
                    <tr>
                        <th style="width:170px"><label for="alarmaddr">IP Address</label></th>
                        <td rowspan="2"><input id="alarmaddr" type="text" placeholder="192.168.1.10" required  /></td>
                    </tr>
                    <tr>
                        <td></td>
                    </tr>
                </div>
        </table>    
        </fieldset>

        <fieldset>
            <p>Port number 1-65535. Default port is 7094.</p>
            <table>
                <div class="field row">
                    <tr>
                        <th style="width:170px;"><label for="alarmport">Port</label></th>
                        <td rowspan="2"><input id="alarmport" type="text" value="false" placeholder="7094" required /></td>
                    </tr>
                </div>
         </table>
        </fieldset>

        <fieldset>
            <p>User code for arming / disarming the system</p>
            <table>
                <div class="field row">
                    <tr>
                        <th style="width:170px;"><label for="alarmcode">Usercode</label></th>
                        <td rowspan="2"><input id="alarmcode" type="text" value="false" placeholder="1" required /></td>
                    </tr>
                </div>
            </table>
        </fieldset>

       
        <fieldset>
            <p>Alarm polling interval in m/s. Default is 5000ms</p>
            <table>
                <div class="field row">
                    <tr>
                        <th style="width:170px;"><label for="alarmpoll">Polling interval (ms)</label></th>
                        <td rowspan="2"><input id="alarmpoll" type="text" placeholder="5000" required/></td>
                    </tr>
                </div>
            </table>
        </fieldset>
        
      
        <button id="save" class="right">Save changes</button>

        <script type="text/javascript">

        // a method named 'onHomeyReady' must be present in your code
        function onHomeyReady( Homey ){

             Homey.get('alarmaddr', function( err, alarmaddr ) {
               if( err ) return Homey.alert( err );
               alarmaddr.value = alarmaddr;
              });

            Homey.get('alarmport', function( err, alarmport ) {
               if( err ) return Homey.alert( err );
               alarmport.value = alarmport;
              });

            Homey.get('alarmcode', function( err, alarmcode ) {
               if( err ) return Homey.alert( err );
               alarmcode.value = alarmcode;
            });

            Homey.get('alarmpoll', function( err, alarmpoll ) {
               if( err ) return Homey.alert( err );
               alarmpoll.value = alarmpoll;
            });


            // Tell Homey we're ready to be displayed
            Homey.ready();

            var alarmaddr = document.getElementById('alarmaddr');
            var alarmport = document.getElementById('alarmport');
            var alarmcode = document.getElementById('alarmcode');
            var alarmpoll = document.getElementById('alarmpoll');
            var saveElement = document.getElementById('save');

            saveElement.addEventListener('click', function(e) {


             // create Regular Expression that validates for IPv4 addresses, then do the actual test on the input.
           var Ipv4RegEx = new RegExp('^(([01]?\\d\\d?|2[0-4]\\d|25[0-5]).){3}([01]?\\d\\d?|2[0-4]\\d|25[0-5])$');
           var IPInputOK = Ipv4RegEx.test(alarmaddr.value);
                if (IPInputOK) {
                    Homey.set('alarmaddr', alarmaddr.value);
                 } else {
                    Homey.alert('No (valid) IP address');
                 }

                if (Number(alarmport.value) >= 1 && Number(alarmport.value) <= 65535 ){
                    Homey.set('alarmport', alarmport.value);
                } else {
                    Homey.alert('Portsetting is out of range');
                }
           
                if (Number(alarmcode.value) >=1 && Number(alarmcode.value) <= 999999) {
                    Homey.set('alarmcode', alarmcode.value);
                 } else {
                    Homey.alert('Not a valid usercode');
                 }

                if (Number(alarmpoll.value) >=1 && Number(alarmpoll.value) <= 9999) {
                    Homey.set('alarmpoll', alarmpoll.value);
                 } else {
                    Homey.alert('Out of range');
                 }
               
                document.getElementById('save').innerHTML = "Settings saved";

            });
        }
        </script>
    </body>
</html>

